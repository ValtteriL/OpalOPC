import { createFetchConfig } from './api-common'
import { type Env } from './index'

export interface CVEResult {
  resultsPerPage: number
  startIndex: number
  totalResults: number
  format: string
  version: string
  timestamp: string
  vulnerabilities: [
    {
      cve: {
        id: string
        sourceIdentifier: string
        published: string
        lastModified: string
        vulnStatus: string
        cisaExploitAdd: string
        cisaActionDue: string
        cisaRequiredAction: string
        cisaVulnerabilityName: string
        descriptions: [
          {
            lang: string
            value: string
          },
        ]
        metrics: {
          cvssMetricV2: [
            {
              source: string
              type: string
              cvssData: {
                version: number
                vectorString: string
                accessVector: string
                accessComplexity: string
                authentication: string
                confidentialityImpact: string
                integrityImpact: string
                availabilityImpact: string
                baseScore: number
              }
              baseSeverity: string
              exploitabilityScore: number
              impactScore: number
              acInsufInfo: boolean
              obtainAllPrivilege: boolean
              obtainUserPrivilege: boolean
              obtainOtherPrivilege: boolean
              userInteractionRequired: boolean
            }
          ]
        }
        weaknesses: [
          {
            source: string
            type: string
            description: [
              {
                lang: string
                value: string
              }
            ]
          }
        ]
        configurations: [
          {
            nodes: [
              {
                operator: string
                negate: boolean
                cpeMatch: [
                  {
                    vulnerable: boolean
                    criteria: string
                    matchCriteriaId: string
                  },
                ]
              }
            ]
          }
        ]
        references: [
          {
            url: string
            source: string
            tags: [
              string
            ]
          },
        ]
      }
    }
  ]
}

type PromiseRejection = never

const baseUri = 'https://services.nvd.nist.gov/rest/json/cves/2.0'

export const getCVEsForCPE = async (cpe: string, env: Env): Promise<CVEResult | PromiseRejection> =>
  await fetch(`${baseUri}?cpeName=${cpe}`, createFetchConfig(env))
    .then(async (response: Response) => {
      if (!response.ok) {
        return await Promise.reject(response.statusText)
      }

      return await response.json()
    })
    .then((data: CVEResult) => data)
