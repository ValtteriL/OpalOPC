import { createFetchConfig, Env } from "./api-common";
import { Env } from "./index";

export type CPEResult = {
		resultsPerPage: number,
		startIndex: number,
		totalResults: number,
		format: string,
		version: string,
		timestamp: string,
		products: [
				{
						cpe: {
								deprecated: boolean,
								cpeName: string,
								cpeNameId: string,
								lastModified: string,
								created: string,
								titles: [
										{
												title: string,
												lang: string,
										}
								],

								refs: [
										{
												ref: string,
												type: string,
										}
								],
								deprecatedBy: [
										{
												cpeName: string,
												cpeNameId: string,
										}
								],
								deprecates: [
										{
												cpeName: string,
												cpeNameId: string,
										}
								],
						},
				}
		],
}

type PromiseRejection = never

const baseUri = "https://services.nvd.nist.gov/rest/json/cpes/2.0"

export const getCPEDetails = (
		query: string, env: Env
): Promise<CPEResult | PromiseRejection> =>
		fetch(`${baseUri}?keywordSearch=${query}`, createFetchConfig(env))
				.then(async (response: Response) => {
						if (!response.ok) {
							return Promise.reject(response.statusText)
						}

					return response.json()
				})
				.then((data: CPEResult) => data)
