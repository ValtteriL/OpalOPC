using System.Collections;
using System.Text.Json;

namespace KnownVulnerabilityAPI.Services
{
    public interface ICPEService
    {
        string constructCPEName(StrictBuildInfo buildInfo);
    }
    public class CPEService(INVDAPIService nvdAPI, INameFormatterService nameFormatter) : ICPEService
    {
        readonly string _version = "2.3";
        readonly string _part = "a";

        public string constructCPEName(StrictBuildInfo buildInfo)
        {
            string vendor = findVendorName(buildInfo.Manufacturer);
            string product = findProductName(buildInfo.ProductName, vendor);
            return $"cpe:{_version}:{_part}:{vendor}:{product}:{buildInfo.SoftwareVersion}:*:*:*:*:*:*:*";
        }

        private string findVendorName(string manufacturer)
        {
            string normalizedName = nameFormatter.FormatName(manufacturer);

            // split the normalizedName by spaces, and create stack of it
            Stack nameStack = new(normalizedName.Split(" "));

            // pop from stack until it's empty
            while (nameStack.Count > 0)
            {
                string query = string.Join(" ", nameStack.ToArray());
                string cpeResult = nvdAPI.QueryCPE(query);

                // if results, get CPEName, take vendor part, and return it
                dynamic json = JsonSerializer.Deserialize<dynamic>(cpeResult) ?? throw new Exception("Failed to parse JSON");

                int numResults = getTotalResults(json);
                if (numResults > 0)
                {
                    string cpeName = getCPEName(json);
                    string vendor = cpeName.Split(':')[3];
                    return vendor;
                }

                nameStack.Pop();
            }

            throw new VendorNotFoundException("Failed to find vendor name");
        }

        private string findProductName(string productName, string vendor)
        {
            string normalizedProductName = nameFormatter.FormatName(productName);

            // split the normalizedName by spaces, and create stack of it
            Stack nameStack = new(normalizedProductName.Split(" "));

            // pop from stack until it's empty
            while (nameStack.Count > 0)
            {
                string subquery = string.Join(" ", nameStack.ToArray());
                string query = $"{vendor} {subquery}";
                string cpeResult = nvdAPI.QueryCPE(query);

                // if results, get CPEName, take vendor part, and return it
                dynamic json = JsonSerializer.Deserialize<dynamic>(cpeResult) ?? throw new Exception("Failed to parse JSON");

                int numResults = getTotalResults(json);
                if (numResults > 0)
                {
                    string cpeName = getCPEName(json);
                    string product = cpeName.Split(':')[4];
                    return product;
                }

                nameStack.Pop();
            }

            throw new ProductNotFoundException("Failed to find product name");
        }

        private static string getTotalResults(dynamic json)
        {
            return json["totalResults"];
        }

        private static string getCPEName(dynamic json)
        {
            return json["products"][0]["cpe"]["cpeName"];
        }
    }
}
