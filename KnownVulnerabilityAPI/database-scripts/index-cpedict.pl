#!/usr/bin/perl

use strict;
use warnings;

use DBI;
use XML::LibXML::Reader;

my ($nvd_xml_file_path, $database) = @ARGV;

unless(defined $nvd_xml_file_path && defined $database) {
    print("usage: $0 <nvd_xml_file_path.gz> <database>\n");
    exit 1;
}

# remove database if it exists
unlink($database);

my $dbh = DBI->connect("dbi:SQLite:uri=file:$database?mode=rwc");

# create a table for full text search
# https://www.sqlitetutorial.net/sqlite-full-text-search/
$dbh->do("
CREATE VIRTUAL TABLE cpedict
USING FTS5(cpe, body)
") or die $dbh->errstr;


# read and parse cpe dict
open my $fh, '<:gzip', $nvd_xml_file_path or die "cannot read file '$nvd_xml_file_path': $!\n";
my $reader = XML::LibXML::Reader->new(IO => $fh);

$dbh->do('BEGIN TRANSACTION'); # batch all inserts into single transaction

while($reader->read) {
    next unless $reader->nodeType == XML_READER_TYPE_ELEMENT;
    next unless $reader->name eq 'cpe-item';

    # extract properties
    my $cpe_item = $reader->copyCurrentNode(1);
    my ($cpe) = $cpe_item =~ /(cpe:2.3:.*)"/;

    # store into db
    my $insert_sth = $dbh->prepare("
    INSERT INTO cpedict(cpe, body)
    VALUES(?, ?)
    ");
    $insert_sth->execute($cpe, $cpe_item) or die $insert_sth->errstr;

    $reader->next;
}

$dbh->do('COMMIT'); # finalize transaction