#!/usr/bin/perl
# query db with cpe data

use strict;
use warnings;

use DBI;

my ($database, $query) = @ARGV;

unless(defined $database && defined $query) {
    print("usage: $0 <database> <query>\n");
    exit 1;
}

my $dbh = DBI->connect("dbi:SQLite:uri=file:$database?mode=ro");

# enclose all substrings in double quotes to be able to search with special characters
# such as dots (for version strings)
# source of requirement: https://www.sqlite.org/fts5.html
my @substrings = split(/\s/, $query);
foreach(@substrings) {
    s/^/"/;
    s/$/"/;
}
my $fixed_query = join(' ', @substrings);


my $sth = $dbh->prepare("
SELECT cpe,body 
FROM cpedict
WHERE body MATCH ? 
ORDER BY rank
") or die $dbh->errstr;
$sth->execute($fixed_query) or die $sth->errstr;

while(my ($cpe, $body) = $sth->fetchrow()) {
    print "Found a match!\n\tcpe = $cpe\n\tbody = $body\n\n";    
}