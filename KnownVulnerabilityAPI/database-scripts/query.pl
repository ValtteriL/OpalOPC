#!/usr/bin/perl

# Query database for CVEs by string
# first finds the CPE, then gets the CVEs
# Usage: query.pl <db-path> <query>

use strict;
use warnings;
use DBI;

my ($db_path, $querystring) = @ARGV;
unless (defined $db_path && defined $querystring) {
  die "Usage: $0 <db-path> <query>\n";
}

my $dbh = DBI->connect("dbi:SQLite:uri=file:$db_path?mode=ro");



# enclose all substrings in double quotes to be able to search with special characters
# such as dots (for version strings)
# source of requirement: https://www.sqlite.org/fts5.html
my @substrings = split(/\s/, $querystring);
foreach(@substrings) {
    s/^/"/;
    s/$/"/;
}
my $fixed_query = join(' ', @substrings);


my $sth = $dbh->prepare("
WITH BestCpeMatch AS (
    SELECT cpe
    FROM cpedict
    WHERE body MATCH ?
    ORDER BY rank
    LIMIT 1
)
SELECT cve.file
FROM cve
JOIN cpe_cves ON cve.id = cpe_cves.cve_id
JOIN cpe ON cpe_cves.cpe_id = cpe.id
JOIN BestCpeMatch ON cpe.cpe = BestCpeMatch.cpe
") or die $dbh->errstr;
$sth->execute($fixed_query) or die $sth->errstr;

while(my ($body) = $sth->fetchrow()) {
    print "Found a match!\n\tbody = $body\n\n";    
}

$dbh->disconnect;
