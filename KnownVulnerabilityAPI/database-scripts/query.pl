#!/usr/bin/perl

# Query database for CPE by string, query for CVEs by CPE
# Usage: query.pl cpe <string> <db-path>
#        query.pl cve <cpe-string> <db-path>

use strict;
use warnings;
use DBI;

my ($command, $querystring, $db_path) = @ARGV;
unless ((defined $command && defined $querystring && defined $db_path) && ($command eq "cpe" || $command eq "cve")) {
  die "Usage: $0 cpe|cve <query> <db-path>\n";
}

my $dbh = DBI->connect("dbi:SQLite:uri=file:$db_path?mode=ro");
my $sth = $command eq "cpe" ? $dbh->prepare("SELECT cpe FROM cpe WHERE cpe LIKE ?") : $dbh->prepare("SELECT cpe,cve FROM cpe INNER JOIN cpe_cves ON (cpe.id = cpe_cves.cpe_id) INNER JOIN cve ON (cpe_cves.cve_id = cve.id) WHERE cpe = ?");
$querystring = $command eq "cpe" ? "%$querystring%" : $querystring;

$sth->execute("$querystring") or die $sth->errstr;
while (my $row = $sth->fetchrow_arrayref) {
  print join(", ", @$row) . "\n";
}
$dbh->disconnect;
